<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cykj.admin.mapper.BusMaintainMapper">

    <!--  查询巴士维修记录 -->
    <select id="queryBusMainTain" resultType="com.cykj.pojo.BusMaintainInfo" parameterType="java.util.Map">
        select bm.id,bm.bus_id,bm.time,bm.state_id,b.number,p.name stateName,a.name repairmanName
        from tb_bus_maintain bm
            left join tb_param p on bm.state_id = p.value and p.type_english = 'busMainTainState'
            left join tb_bus b on bm.bus_id = b.id
            left join tb_admin a on b.repairman_id = a.id
        <where>
            b.city_id = #{cityId}
            <if test="id !=null and id !='' ">
                and bm.id = #{id}
            </if>
            <if test="number !=null and number !='' ">
                and b.id like concat('%',#{number},'%')
            </if>
            <if test="cityId !=null and cityId !='' ">
                and b.city_id = #{cityId}
            </if>
        </where>
    </select>

    <!--  查询单个巴士  -->
    <select id="queryOneBus" resultType="com.cykj.pojo.Bus" parameterType="java.lang.String">
        select *
            from tb_bus
                where number = #{number}
                <if test=" id != 0 and id !=null">
                    and id != #{id}
                </if>
    </select>

    <!--  修改巴士,模拟删除  -->
    <update id="changeBus" parameterType="com.cykj.pojo.Bus">
        update tb_bus
        <set>
            <if test=" number!=null and number!=''">
                number = #{number},
            </if>
            <if test=" isFixedLine!=null and isFixedLine!=''">
                is_fixed_line = #{isFixedLine},
            </if>
            <if test=" stateId!=null and stateId!=''">
                state_id = #{stateId},
            </if>
            <if test=" repairmanId!=null and repairmanId!=''">
                repairman_id = #{repairmanId},
            </if>
            <if test=" userTimeRatio!=null and userTimeRatio!=''">
                user_time_ratio = #{userTimeRatio},
            </if>
            <if test=" cityId!=null and cityId!=''">
                city_id = #{cityId},
            </if>
        </set>
        where id = #{id}
    </update>

    <!--  新增巴士-->
    <insert id="insertBus" parameterType="com.cykj.pojo.Bus" keyProperty="id" useGeneratedKeys="true">
        insert into tb_bus
            (number,
             state_id,
             end_time,
             city_id,
             is_fixed_line,
             repairman_id,
             production_time)
        values
               (#{number},
               1,
               #{endTime},
               #{cityId},
               '是',
               #{repairmanId},
               #{productionTime})
    </insert>

</mapper>