<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cykj.admin.mapper.BusWorkMapper">

    <!--  查询巴士排班 -->
    <select id="queryBusWork" resultType="com.cykj.pojo.BusWorkInfo" parameterType="java.lang.Integer">
        select bw.*,t.time departureTime,l.name lineName,l.start_time,l.return_time,b.number,l.start_time+l.return_time+p.value all_time
        from tb_bus_work bw
                 left join tb_time t on bw.time_id = t.id
                 left join tb_line l on bw.line_id = l.id
                 left join tb_bus b on bw.bus_id = b.id
                 left join tb_param p on p.type_english = 'arriveSiteRest'
        where b.id = #{id}
    </select>

    <!--  新增巴士排班-->
    <insert id="insertBusWork" parameterType="com.cykj.pojo.BusWorkInfo" keyProperty="id" useGeneratedKeys="true">
        insert into tb_bus_work
            (bus_id,
             line_id,
             time_id,
             start_begin_or_return,
             is_addup
             )
        values
               (#{busId},
                #{lineId},
                #{timeId},
                #{startBeginOrReturn},
                #{isAddup}
               )
    </insert>

    <!--  修改巴士排班-->
    <update id="changeBusWork" parameterType="com.cykj.pojo.BusWorkInfo">
        update tb_bus_work
        <set>
            <if test=" title!=null and title!=''">
                title = #{title},
            </if>
            <if test=" isCarousel!=null and isCarousel!=''">
                is_carousel = #{isCarousel},
            </if>
            <if test=" endTime!=null and endTime!=''">
                end_time = #{endTime},
            </if>
            <if test=" stateId!=null and stateId!=''">
                state_id = #{stateId},
            </if>
            <if test=" imgUrl!=null and imgUrl!=''">
                img_url = #{imgUrl},
            </if>
            <if test=" advertiserX!=null and advertiserX!=''">
                advertiser_x = #{advertiserX},
            </if>
            <if test=" advertiserY!=null and advertiserY!=''">
                advertiser_y = #{advertiserY},
            </if>
        </set>
        where id = #{id}
    </update>

    <!--查询线路班次-->
    <select id="findBusWorkByLineId" parameterType="busWork" resultType="busWorkInfo">
       SELECT
            t.time time,
            b.number number,
        IF (
            STRCMP(bw.is_addup ,'否'),
            '加开',
          ''
        ) remarks
        FROM
            tb_bus_work bw
        INNER JOIN tb_time t ON bw.time_id = t.id
        INNER JOIN tb_bus b ON b.id = bw.bus_id
        INNER JOIN tb_param p ON p.type_english = 'busDirection'
        AND p.VALUE= bw.start_begin_or_return
        AND p.VALUE=#{startBeginOrReturn}
        WHERE
            bw.line_id = #{lineId} order by t.id
    </select>
</mapper>