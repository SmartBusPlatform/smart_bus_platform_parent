<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cykj.admin.mapper.BusMapper">

    <!--  查询巴士  -->
    <select id="queryBus" resultType="com.cykj.pojo.BusInfo" parameterType="java.util.Map">
        select b.*, p.name stateName, a.name cityName, ad.name repairmanName,bl.line_id lineId,l.name lineName,a2.id provinceId
        from tb_bus b
            left join tb_param p on b.state_id = p.value and p.type_english = 'busState'
            left join tb_areas a on b.city_id = a.id
            left join tb_areas a2 on a2.id = a.parent_id
            left join tb_admin ad on b.repairman_id = ad.id
            left join tb_bus_line bl on b.id = bl.bus_id
            left join tb_line l on bl.line_id = l.id
        <where>
            <if test="id !=null and id !='' ">
                and b.id = #{id}
            </if>
            <if test="isFixedLine !=null and isFixedLine !='' ">
                and b.is_fixed_line = #{isFixedLine}
            </if>
            <if test="lineName !=null and lineName !='' ">
                and l.name like concat('%',#{lineName},'%')
            </if>
            <if test="repairmanName !=null and repairmanName !='' ">
                and ad.name = #{repairmanName}
            </if>
            <if test="number !=null and number !='' ">
                and b.number = #{number}
            </if>
            <if test="stateId !=null and stateId !='' ">
                and b.state_Id = #{stateId}
            </if>
        </where>
    </select>

    <!--  查询单个巴士  -->
    <select id="queryOneBus" resultType="com.cykj.pojo.Bus" parameterType="java.lang.String">
        select *
            from tb_bus
                where number = #{number}
                <if test=" id != 0 and id !=null">
                    and id != #{id}
                </if>
    </select>

    <!--  修改巴士,模拟删除  -->
    <update id="changeBus" parameterType="com.cykj.pojo.Bus">
        update tb_bus
        <set>
            <if test=" number!=null and number!=''">
                number = #{number},
            </if>
            <if test=" isFixedLine!=null and isFixedLine!=''">
                is_fixed_line = #{isFixedLine},
            </if>
            <if test=" stateId!=null and stateId!=''">
                state_id = #{stateId},
            </if>
            <if test=" repairmanId!=null and repairmanId!=''">
                repairman_id = #{repairmanId},
            </if>
            <if test=" userTimeRatio!=null and userTimeRatio!=''">
                user_time_ratio = #{userTimeRatio},
            </if>
            <if test=" cityId!=null and cityId!=''">
                city_id = #{cityId},
            </if>
        </set>
        where id = #{id}
    </update>

    <!--  新增巴士-->
    <insert id="insertBus" parameterType="com.cykj.pojo.Bus" keyProperty="id" useGeneratedKeys="true">
        insert into tb_bus
            (number,
             state_id,
             end_time,
             city_id,
             is_fixed_line,
             repairman_id,
             production_time)
        values
               (#{number},
               1,
               #{endTime},
               #{cityId},
               '是',
               #{repairmanId},
               #{productionTime})
    </insert>

</mapper>